version: 2.1

orbs:
  crystal: manastech/crystal@1.0.0

commands:
  shards-make-test:
    steps:
      - run:
          name: git config
          command: |
            git config --global user.email "you@example.com"
            git config --global user.name "Your Name"
            git config --global column.ui always
      - crystal/version
      - checkout
      - crystal/shards-install
      - run: make
      - run: make test
      - crystal/format-check

jobs:
  test:
    docker:
      - image: crystallang/crystal:latest
    steps:
      - shards-make-test

  test-on-osx:
    macos:
      xcode: 11.1.0 # latest mojave
    steps:
      - run:
          name: Install Crystal
          command: brew install crystal
      - shards-make-test

  test-on-nightly:
    docker:
      - image: crystallang/crystal:nightly
    steps:
      - shards-make-test

workflows:
  version: 2
  ci:
    jobs:
      - test
      - test-on-osx
  nightly:
    triggers:
      - schedule:
          cron: '0 2 * * *'
          filters:
            branches:
              only:
                - master
    jobs:
      - test-on-nightly
